{"version":3,"file":"annotate.min.js","sources":["../src/annotate.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript to handle ouwiki.\n *\n * @module mod_ouwiki/annotate\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport AnnotateModal from 'mod_ouwiki/annotatemodal';\nimport * as FocusLockManager from 'core/local/aria/focuslock';\nimport ModalEvents from 'core/modal_events';\n\nclass Annotate {\n    constructor() {\n        this.currentMarker = null;\n        this.modal = null;\n    }\n\n    /**\n     * Initialize the Annotate module.\n     */\n    async init() {\n        await this.setupDialog();\n        await this.setupMarkers();\n    }\n\n    async setupDialog() {\n        this.modal = await AnnotateModal.create({});\n    }\n\n    /**\n     * Show the annotation dialog.\n     * @param {HTMLElement} marker The annotation marker element\n     */\n    async showDialog(marker) {\n        if (!this.modal) {\n            return;\n        }\n\n        this.currentMarker = marker.id;\n\n        // Clear the textarea and show the modal.\n        const annotationTextArea = this.modal.getBody().find('#annotationtext');\n        if (annotationTextArea.length) {\n            annotationTextArea.val('');\n            annotationTextArea.focus();\n        }\n        await this.setupDialog();\n        this.modal.show();\n        const $root = await this.modal.getRoot();\n        const textarea = $root.find('#annotationtext')[0];\n        // Lock tab control inside modal.\n        FocusLockManager.trapFocus(document.querySelector('.annotate-modal'));\n        $root.on(ModalEvents.shown, () => {\n            textarea.focus();\n        });\n        $root.on(ModalEvents.hidden, () => {\n            this.modal.destroy();\n            FocusLockManager.untrapFocus();\n        });\n        $root.on(ModalEvents.save, (e) => {\n            e.preventDefault();\n            const annotationText = $root.find('#annotationtext').val();\n            this.newAnnotation(annotationText);\n            this.modal.hide();\n        });\n    }\n\n    /**\n     * Setup annotation markers with event listeners.\n     */\n    async setupMarkers() {\n        const markers = document.querySelectorAll('span.ouwiki-annotation-marker');\n        markers.forEach((marker) => {\n            marker.style.cursor = 'pointer';\n            marker.tabIndex = 0;\n\n            marker.addEventListener('keydown', async(e) => {\n                if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    await this.showDialog(marker);\n                }\n            });\n\n            marker.addEventListener('click', async() => {\n                await this.showDialog(marker);\n            });\n        });\n    }\n\n    /**\n     * Create a new annotation.\n     * @param {string} newText The text of the new annotation.\n     */\n    newAnnotation(newText) {\n        // Get the number of the next form textarea.\n        const annotationCount = document.getElementById('annotationcount');\n        const annotationNum = parseInt(annotationCount?.textContent || '0', 10) + 1;\n\n        // Create the new form section.\n        const newFItem = document.createElement('div');\n        newFItem.id = `newfitem${annotationNum}`;\n        newFItem.className = 'fitem';\n        newFItem.style.display = 'none';\n\n        // Create the title div with label.\n        const fItemTitle = document.createElement('div');\n        fItemTitle.className = 'fitemtitle';\n\n        const fItemLabel = document.createElement('label');\n        fItemLabel.htmlFor = `id_annotationedit${annotationNum}`;\n        fItemLabel.textContent = annotationNum;\n        fItemTitle.appendChild(fItemLabel);\n\n        // Create the div for the textarea.\n        const fElement = document.createElement('div');\n        fElement.className = 'felement ftextarea';\n\n        const fElementTextarea = document.createElement('textarea');\n        fElementTextarea.id = `id_annotationedit${annotationNum}`;\n        fElementTextarea.name = `new${this.currentMarker.substring(6)}`;\n        fElementTextarea.rows = 3;\n        fElementTextarea.cols = 40;\n        fElementTextarea.value = newText;\n        fElementTextarea.textContent = newText;\n\n        fElement.appendChild(fElementTextarea);\n\n        // Append the title and textarea to the new form section.\n        newFItem.appendChild(fItemTitle);\n        newFItem.appendChild(fElement);\n\n        // Insert the new fitem before the last fitem (which is the delete orphaned checkbox).\n        const endMarker = document.getElementById('end');\n        const fContainer = endMarker.parentNode.parentNode.parentNode;\n        fContainer.insertBefore(newFItem, endMarker.parentNode.parentNode);\n\n        // Update the marker ID.\n        const markerId = this.markNewAnnotation(annotationNum);\n\n        // Show the new form section.\n        newFItem.style.display = 'block';\n\n        // Update the annotation count.\n        annotationCount.textContent = annotationNum;\n\n        // Focus on the next marker or the first annotation text.\n        if (markerId !== 0) {\n            const nextMarker = document.getElementById(markerId);\n            setTimeout(() => nextMarker.focus(), 0);\n        } else {\n            const firstTextArea = document.querySelector('.felement .ftextarea');\n            if (firstTextArea) {\n                setTimeout(() => firstTextArea.focus(), 0);\n            }\n        }\n    }\n\n    /**\n     * Updates the annotation marker and replaces the current marker with a visual strong element.\n     *\n     * @param {number} annotationNum The number to associate with the current annotation\n     * @returns {number} The ID of the next marker if it exists, otherwise 0\n     */\n    markNewAnnotation(annotationNum) {\n        // Get the current marker and list of all markers.\n        const markers = Array.from(document.querySelectorAll('span.ouwiki-annotation-marker'));\n        let nextMarkerId = 0;\n\n        // Find the next marker after the current one.\n        markers.forEach((marker, index) => {\n            if (marker.id === this.currentMarker) {\n                if (index < markers.length - 1) {\n                    // Get the ID of the next marker.\n                    nextMarkerId = markers[index + 1].id;\n                }\n            }\n        });\n\n        // Replace the current marker with a strong element.\n        const theMarker = document.getElementById(this.currentMarker);\n        if (theMarker) {\n            const visualMarker = document.createElement('strong');\n            visualMarker.textContent = `(${annotationNum})`;\n            theMarker.parentNode.insertBefore(visualMarker, theMarker);\n            theMarker.remove();\n        }\n\n        return nextMarkerId;\n    }\n}\n\nexport const init = (args) => {\n    const annotate = new Annotate();\n    annotate.init(args);\n};\n"],"names":["Annotate","constructor","currentMarker","modal","this","setupDialog","setupMarkers","AnnotateModal","create","marker","id","annotationTextArea","getBody","find","length","val","focus","show","$root","getRoot","textarea","FocusLockManager","trapFocus","document","querySelector","on","ModalEvents","shown","hidden","destroy","untrapFocus","save","e","preventDefault","annotationText","newAnnotation","hide","querySelectorAll","forEach","style","cursor","tabIndex","addEventListener","async","key","showDialog","newText","annotationCount","getElementById","annotationNum","parseInt","textContent","newFItem","createElement","className","display","fItemTitle","fItemLabel","htmlFor","appendChild","fElement","fElementTextarea","name","substring","rows","cols","value","endMarker","parentNode","insertBefore","markerId","markNewAnnotation","nextMarker","setTimeout","firstTextArea","markers","Array","from","nextMarkerId","index","theMarker","visualMarker","remove","args","init"],"mappings":";;;;;;;k3BA2BMA,SACFC,mBACSC,cAAgB,UAChBC,MAAQ,wBAOPC,KAAKC,oBACLD,KAAKE,wCAINH,YAAcI,uBAAcC,OAAO,qBAO3BC,YACRL,KAAKD,kBAILD,cAAgBO,OAAOC,SAGtBC,mBAAqBP,KAAKD,MAAMS,UAAUC,KAAK,mBACjDF,mBAAmBG,SACnBH,mBAAmBI,IAAI,IACvBJ,mBAAmBK,eAEjBZ,KAAKC,mBACNF,MAAMc,aACLC,YAAcd,KAAKD,MAAMgB,UACzBC,SAAWF,MAAML,KAAK,mBAAmB,GAE/CQ,iBAAiBC,UAAUC,SAASC,cAAc,oBAClDN,MAAMO,GAAGC,sBAAYC,OAAO,KACxBP,SAASJ,WAEbE,MAAMO,GAAGC,sBAAYE,QAAQ,UACpBzB,MAAM0B,UACXR,iBAAiBS,iBAErBZ,MAAMO,GAAGC,sBAAYK,MAAOC,IACxBA,EAAEC,uBACIC,eAAiBhB,MAAML,KAAK,mBAAmBE,WAChDoB,cAAcD,qBACd/B,MAAMiC,+BAQCb,SAASc,iBAAiB,iCAClCC,SAAS7B,SACbA,OAAO8B,MAAMC,OAAS,UACtB/B,OAAOgC,SAAW,EAElBhC,OAAOiC,iBAAiB,WAAWC,MAAAA,IACjB,UAAVX,EAAEY,KAA6B,MAAVZ,EAAEY,MACvBZ,EAAEC,uBACI7B,KAAKyC,WAAWpC,YAI9BA,OAAOiC,iBAAiB,SAASC,gBACvBvC,KAAKyC,WAAWpC,cASlC0B,cAAcW,eAEJC,gBAAkBxB,SAASyB,eAAe,mBAC1CC,cAAgBC,UAASH,MAAAA,uBAAAA,gBAAiBI,cAAe,IAAK,IAAM,EAGpEC,SAAW7B,SAAS8B,cAAc,OACxCD,SAAS1C,qBAAgBuC,eACzBG,SAASE,UAAY,QACrBF,SAASb,MAAMgB,QAAU,aAGnBC,WAAajC,SAAS8B,cAAc,OAC1CG,WAAWF,UAAY,mBAEjBG,WAAalC,SAAS8B,cAAc,SAC1CI,WAAWC,mCAA8BT,eACzCQ,WAAWN,YAAcF,cACzBO,WAAWG,YAAYF,kBAGjBG,SAAWrC,SAAS8B,cAAc,OACxCO,SAASN,UAAY,2BAEfO,iBAAmBtC,SAAS8B,cAAc,YAChDQ,iBAAiBnD,8BAAyBuC,eAC1CY,iBAAiBC,kBAAa1D,KAAKF,cAAc6D,UAAU,IAC3DF,iBAAiBG,KAAO,EACxBH,iBAAiBI,KAAO,GACxBJ,iBAAiBK,MAAQpB,QACzBe,iBAAiBV,YAAcL,QAE/Bc,SAASD,YAAYE,kBAGrBT,SAASO,YAAYH,YACrBJ,SAASO,YAAYC,gBAGfO,UAAY5C,SAASyB,eAAe,OACvBmB,UAAUC,WAAWA,WAAWA,WACxCC,aAAajB,SAAUe,UAAUC,WAAWA,kBAGjDE,SAAWlE,KAAKmE,kBAAkBtB,kBAGxCG,SAASb,MAAMgB,QAAU,QAGzBR,gBAAgBI,YAAcF,cAGb,IAAbqB,SAAgB,OACVE,WAAajD,SAASyB,eAAesB,UAC3CG,YAAW,IAAMD,WAAWxD,SAAS,OAClC,OACG0D,cAAgBnD,SAASC,cAAc,wBACzCkD,eACAD,YAAW,IAAMC,cAAc1D,SAAS,IAWpDuD,kBAAkBtB,qBAER0B,QAAUC,MAAMC,KAAKtD,SAASc,iBAAiB,sCACjDyC,aAAe,EAGnBH,QAAQrC,SAAQ,CAAC7B,OAAQsE,SACjBtE,OAAOC,KAAON,KAAKF,eACf6E,MAAQJ,QAAQ7D,OAAS,IAEzBgE,aAAeH,QAAQI,MAAQ,GAAGrE,aAMxCsE,UAAYzD,SAASyB,eAAe5C,KAAKF,kBAC3C8E,UAAW,OACLC,aAAe1D,SAAS8B,cAAc,UAC5C4B,aAAa9B,uBAAkBF,mBAC/B+B,UAAUZ,WAAWC,aAAaY,aAAcD,WAChDA,UAAUE,gBAGPJ,4BAIMK,QACA,IAAInF,UACZoF,KAAKD"}