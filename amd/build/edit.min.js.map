{"version":3,"file":"edit.min.js","sources":["../src/edit.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\nimport {getString} from 'core/str';\nimport Notification from 'core/notification';\nimport Config from 'core/config';\nimport Pending from 'core/pending';\nimport * as FormChangeChecker from 'core_form/changechecker';\n\n/**\n * JavaScript to handle ouwiki.\n *\n * @module mod_ouwiki/edit\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nclass Edit {\n    /**\n     * Constructor for the Edit class.\n     * @param {number} contextId The context ID for validation.\n     */\n    constructor(contextId) {\n        this.contextId = contextId;\n        this.init();\n    }\n\n    /**\n     * Initialize the Edit class by loading strings and attaching events.\n     */\n    init() {\n        const btns = document.querySelectorAll('#id_savechanges, #id_preview');\n        btns.forEach((btn) => {\n            btn.addEventListener('click', (e) => {\n                this.handleButtonClick(e, btns);\n            });\n        });\n    }\n\n    /**\n     * Check the save response for success and handle failure if necessary.\n     *\n     * @param {XMLHttpRequest} response The XMLHttpRequest response\n     * @param {Event} e The click event\n     * @param {NodeList} btns The list of save buttons\n     */\n    checkSave = (response, e, btns) => {\n        if (response.responseText.search('ok') === -1) {\n            // Send save failed due to login/session error.\n            this.saveFail('savefailsession', response.responseText, btns);\n        } else {\n            // If the response is OK, allow form submission.\n            const form = e.target.closest('form');\n            if (form) {\n                // Add a hidden input to simulate the clicked button.\n                const clickedButton = e.target;\n                if (clickedButton.name) {\n                    const hiddenInput = document.createElement('input');\n                    hiddenInput.type = 'hidden';\n                    hiddenInput.name = clickedButton.name;\n                    hiddenInput.value = clickedButton.value;\n                    form.appendChild(hiddenInput);\n                }\n\n                // Manually submit the form.\n                FormChangeChecker.disableAllChecks();\n                if (form.requestSubmit) {\n                    form.requestSubmit(e.target);\n                } else {\n                    form.submit();\n                }\n            }\n        }\n    };\n\n    /**\n     * Handle network or timeout failures for save request.\n     *\n     * @param {Error} error - The error object\n     * @param {NodeList} btns - The list of save buttons\n     */\n    checkFailure = (error, btns) => {\n        this.saveFail('savefailnetwork', error.statusText, btns);\n    };\n\n    /**\n     * Send an XMLHttpRequest to verify session status.\n     *\n     * @param {Function} onSuccess Callback function on successful response\n     * @param {Function} onFailure Callback function on error/timeout\n     */\n    sendCheckRequest = (onSuccess, onFailure) => {\n        const xhr = new XMLHttpRequest();\n        const params = `sesskey=${Config.sesskey}&contextid=${this.contextId}`;\n        xhr.open('POST', 'confirmloggedin.php', true);\n        xhr.timeout = 30000;\n\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === XMLHttpRequest.DONE) {\n                if (xhr.status === 200) {\n                    onSuccess(xhr);\n                } else {\n                    onFailure(xhr);\n                }\n            }\n        };\n\n        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        xhr.send(params);\n    };\n\n    /**\n     * Handle the click event of save buttons.\n     *\n     * @param {Event} e The click event\n     * @param {NodeList} btns The list of save buttons\n     */\n    handleButtonClick = (e, btns) => {\n        e.preventDefault();\n        const pendingPromise = new Pending('mod/ouwiki:savecheck');\n        this.sendCheckRequest(\n            (response) => {\n                this.checkSave(response, e, btns);\n                pendingPromise.resolve();\n            },\n            (error) =>  {\n                this.checkFailure(error, btns);\n                pendingPromise.resolve();\n            }\n        );\n    };\n\n    /**\n     * Handle save failure scenario by displaying an alert and disabling buttons.\n     *\n     * @param {string} stringName The name of the failure string\n     * @param {string} info Additional info for the alert\n     * @param {NodeList} btns The list of save buttons\n     */\n    saveFail = async(stringName, info, btns) => {\n        let content = await getString('savefailtext', 'ouwiki', await getString(stringName, 'ouwiki'));\n        content += `[${info}]`;\n\n        btns.forEach(btn => {\n            btn.disabled = true;\n        });\n\n        Notification.alert(await getString('savefailtitle', 'ouwiki'), content);\n        const cancel = document.querySelector('#id_cancel');\n        if (cancel) {\n            cancel.addEventListener('click', () => {\n                const form = document.querySelector('.region-content .mform');\n                if (form) {\n                    const text = form.querySelector('#fitem_id_message');\n                    const attach = form.querySelector('#fitem_id_attachments');\n                    if (text) {\n                        text.remove();\n                    }\n                    if (attach) {\n                        attach.remove();\n                    }\n                    form.method = 'get';\n                }\n            });\n        }\n    };\n}\n\nexport const init = (contextId) => {\n    return new Edit(contextId);\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","_notification","_config","_pending","FormChangeChecker","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireWildcard","Edit","constructor","contextId","this","init","btns","document","querySelectorAll","forEach","btn","addEventListener","handleButtonClick","checkSave","response","responseText","search","saveFail","form","target","closest","clickedButton","name","hiddenInput","createElement","type","value","appendChild","disableAllChecks","requestSubmit","submit","checkFailure","error","statusText","sendCheckRequest","onSuccess","onFailure","xhr","XMLHttpRequest","params","Config","sesskey","open","timeout","onreadystatechange","readyState","DONE","status","setRequestHeader","send","preventDefault","pendingPromise","Pending","resolve","async","stringName","info","content","getString","disabled","Notification","alert","cancel","querySelector","text","attach","remove","method","_exports"],"mappings":"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"}