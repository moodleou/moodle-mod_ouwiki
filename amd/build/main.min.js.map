{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {getString} from 'core/str';\nimport Pending from 'core/pending';\n/**\n * JavaScript to handle ouwiki.\n *\n * @module mod_ouwiki/main\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nclass Main {\n    constructor() {}\n\n    /**\n     * Initialize event listeners and set up annotation handling.\n     */\n    init() {\n        const iconShow = document.getElementById('showannotationicons');\n        const iconHide = document.getElementById('hideannotationicons');\n\n        if (iconShow) {\n            iconShow.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.showAnnotationIcons(true);\n                setTimeout(() => document.getElementById('hideannotationicons')?.focus(), 0);\n            });\n        }\n\n        if (iconHide) {\n            iconHide.addEventListener('click', (e) => {\n                e.preventDefault();\n                this.showAnnotationIcons(false);\n                setTimeout(() => document.getElementById('showannotationicons')?.focus(), 0);\n            });\n        }\n\n        const annoSpans = document.querySelectorAll('span.ouwiki-annotation-tag');\n        if (annoSpans.length > 0) {\n            this.ouwikiShowAllAnnotations('none');\n            annoSpans.forEach((span) => this.setupSpans(span));\n        }\n\n        const createButton = document.getElementById('ouw_create');\n        if (createButton) {\n            this.ouwikiSetFields();\n        }\n        this.setupExpandCollapseAnnotations();\n    }\n\n    /**\n     * Show or hide annotation icons.\n     * @param {boolean} show  Whether to show the annotation icons\n     */\n    showAnnotationIcons(show) {\n        const pending = new Pending(\"mod_ouwiki/showannotationicons\");\n        const container = document.querySelector('.ouwiki-content');\n        const hideClass = 'ouwiki-hide-annotations';\n        if (container) {\n            if (show) {\n                container.classList.remove(hideClass);\n            } else {\n                container.classList.add(hideClass);\n            }\n        }\n\n        const url = show\n            ? document.querySelector('#showannotationicons')?.href\n            : document.querySelector('#hideannotationicons')?.href;\n\n        if (url) {\n            fetch(`${url}&ajax=1`);\n            pending.resolve();\n        }\n    }\n\n    /**\n     * Initialize fields for creating new pages.\n     */\n    async ouwikiSetFields() {\n        const createButton = document.getElementById('ouw_create');\n        const pageName = document.getElementById('ouw_newpagename');\n        const addButton = document.getElementById('ouw_add');\n        const sectionName = document.getElementById('ouw_newsectionname');\n\n        // Fetch localized strings.\n        const typeInPageName = await getString('typeinpagename', 'ouwiki');\n        const typeInSectionName = await getString('typeinsectionname', 'ouwiki');\n\n        // Initialize page creation fields.\n        if (createButton && pageName) {\n            createButton.disabled = true;\n            pageName.style.color = 'gray';\n            pageName.value = typeInPageName;\n            pageName.addEventListener('focus', () => this.ouwikiResetField(pageName));\n            pageName.addEventListener('keyup', () =>\n                this.ouwikiClearDisabled(createButton, pageName)\n            );\n        }\n\n        // Initialize section creation fields.\n        if (addButton && sectionName) {\n            addButton.disabled = true;\n            sectionName.style.color = 'gray';\n            sectionName.value = typeInSectionName;\n            sectionName.addEventListener('focus', () => this.ouwikiResetField(sectionName));\n            sectionName.addEventListener('keyup', () =>\n                this.ouwikiClearDisabled(addButton, sectionName)\n            );\n        }\n    }\n\n    /**\n     * Enable or disable a button based on the presence of text in a field.\n     * @param {HTMLElement} button  The button to enable or disable\n     * @param {HTMLElement} field The text field to monitor\n     */\n    ouwikiClearDisabled(button, field) {\n        button.disabled = !field.value.trim();\n    }\n\n    /**\n     * Reset a field to an empty state if it contains a placeholder.\n     * @param {HTMLElement} field The field to reset\n     */\n    ouwikiResetField(field) {\n        if (field.style.color === 'gray') {\n            field.value = '';\n            field.style.color = 'black';\n        }\n    }\n\n    /**\n     * Show or hide all annotation boxes.\n     * @param {string} action The CSS display value ('block' or 'none')\n     */\n    async ouwikiShowAllAnnotations(action) {\n        const annoBoxes = document.querySelectorAll('span.ouwiki-annotation');\n        const collapseAnnotation = await getString('collapseannotation', 'ouwiki');\n        const expandAnnotation = await getString('expandannotation', 'ouwiki');\n        annoBoxes.forEach((box) => {\n            box.style.display = action;\n            const imgTag = box.parentNode.querySelector('img');\n            if (imgTag) {\n                imgTag.alt = action === 'block' ? collapseAnnotation : expandAnnotation;\n                imgTag.title = action === 'block' ? collapseAnnotation : expandAnnotation;\n            }\n        });\n\n        if (action === 'block') {\n            this.ouwikiSwapAnnotationUrl('hide');\n        } else {\n            this.ouwikiSwapAnnotationUrl('show');\n        }\n    }\n\n    /**\n     * Swap the URLs for showing or hiding all annotations.\n     * @param {string} action The action to perform ('hide' or 'show')\n     */\n    ouwikiSwapAnnotationUrl(action) {\n        const show = document.getElementById('expandallannotations');\n        const hide = document.getElementById('collapseallannotations');\n        if (show && hide) {\n            if (action === 'hide') {\n                show.style.display = 'none';\n                hide.style.display = 'inline';\n            } else {\n                show.style.display = 'inline';\n                hide.style.display = 'none';\n            }\n        }\n    }\n\n    /**\n     * Set up event listeners for expand and collapse annotations.\n     */\n    setupExpandCollapseAnnotations() {\n        const links = document.querySelectorAll('#expandcollapseannotations a');\n        links.forEach((link) => {\n            link.addEventListener('click', (e) => {\n                e.preventDefault();\n                const action = link.dataset.action;\n                if (action === 'expand') {\n                    this.ouwikiShowAllAnnotations('block');\n                } else if (action === 'collapse') {\n                    this.ouwikiShowAllAnnotations('none');\n                }\n            });\n        });\n    }\n\n    /**\n     * Set up click and keyboard events for annotation spans.\n     * @param {HTMLElement} span The annotation span to set up\n     */\n    setupSpans(span) {\n        span.style.cursor = 'pointer';\n        span.tabIndex = 0;\n\n        span.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter' || e.key === ' ') {\n                this.ouwikiShowHideAnnotation(`annotationbox${span.id.substring(10)}`);\n                e.preventDefault();\n            }\n        });\n\n        span.addEventListener('click', () => {\n            this.ouwikiShowHideAnnotation(`annotationbox${span.id.substring(10)}`);\n        });\n    }\n\n    /**\n     * Show or hide a specific annotation box.\n     * @param {string} id The ID of the annotation box to toggle\n     */\n    async ouwikiShowHideAnnotation(id) {\n        const box = document.getElementById(id);\n        const annotag = box.parentNode;\n        const imgTag = annotag.querySelector('img');\n\n        if (box.style.display === 'block') {\n            box.style.display = 'none';\n            imgTag.alt = await getString('expandannotation', 'ouwiki');\n            imgTag.title = await getString('expandannotation', 'ouwiki');\n            this.ouwikiSwapAnnotationUrl('show');\n        } else {\n            box.style.display = 'block';\n            imgTag.alt = await getString('collapseannotation', 'ouwiki');\n            imgTag.title = await getString('collapseannotation', 'ouwiki');\n\n            const annoBoxes = document.querySelectorAll('span.ouwiki-annotation');\n            const allVisible = Array.from(annoBoxes).every(\n                (el) => el.style.display === 'block'\n            );\n\n            if (allVisible) {\n                this.ouwikiSwapAnnotationUrl('hide');\n            }\n        }\n    }\n}\n\nexport const init = () => {\n    const main = new Main();\n    main.init();\n};\n"],"names":["Main","constructor","init","iconShow","document","getElementById","iconHide","addEventListener","e","preventDefault","showAnnotationIcons","setTimeout","_document$getElementB","focus","_document$getElementB2","annoSpans","querySelectorAll","length","ouwikiShowAllAnnotations","forEach","span","this","setupSpans","ouwikiSetFields","setupExpandCollapseAnnotations","show","pending","Pending","container","querySelector","classList","remove","add","url","_document$querySelect","href","_document$querySelect2","fetch","resolve","createButton","pageName","addButton","sectionName","typeInPageName","typeInSectionName","disabled","style","color","value","ouwikiResetField","ouwikiClearDisabled","button","field","trim","action","annoBoxes","collapseAnnotation","expandAnnotation","box","display","imgTag","parentNode","alt","title","ouwikiSwapAnnotationUrl","hide","link","dataset","cursor","tabIndex","key","ouwikiShowHideAnnotation","id","substring","Array","from","every","el"],"mappings":"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"}